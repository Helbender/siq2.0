from datetime import date
from enum import Enum

from sqlalchemy import Date, ForeignKey, Integer, String
from sqlalchemy import Enum as SQLEnum
from sqlalchemy.orm import Mapped, mapped_column, relationship

# class Base(DeclarativeBase):
#     pass
from models.users import Base  # type: ignore


class TipoTripulante(Enum):
    PILOTO = "PILOTO"
    OPERADOR_CABINE = "OPERADOR_CABINE"
    CONTROLADOR_TATICO = "CONTROLADOR_TATICO"
    OPERADOR_VIGILANCIA = "OPERADOR_VIGILANCIA"
    OPERAÇÕES = "OPERAÇÕES"


class GrupoQualificações(Enum):
    ALERTA = "ALERTA"
    VIGILANCIA = "VIGILANCIA"
    NVG = "NVG"
    TATICO = "TATICO"
    OUTROS = "OUTROS"


class Tripulante(Base):
    __tablename__ = "tripulantes"

    nip: Mapped[int] = mapped_column(primary_key=True)
    nome: Mapped[str] = mapped_column(String(100), nullable=False)
    rank: Mapped[str] = mapped_column(String(5))
    position: Mapped[str] = mapped_column(String(5))
    email: Mapped[str] = mapped_column(String(50))
    admin: Mapped[bool] = mapped_column(default=False)
    recover: Mapped[str] = mapped_column(String(500), default="")
    squadron: Mapped[str] = mapped_column(String(30), default="")
    password: Mapped[str] = mapped_column(String(150))
    tipo: Mapped[TipoTripulante] = mapped_column(
        SQLEnum(TipoTripulante), nullable=False
    )

    qualificacoes: Mapped[list["TripulanteQualificacao"]] = relationship(
        back_populates="tripulante", cascade="all, delete-orphan"
    )

    def to_json(self):
        response = {
            # "nip": self.nip,
            # "nome": self.nome,
            # "rank": self.rank,
            # "position": self.position,
            # "email": self.email,
            # "admin": self.admin,
            # "squadron": self.squadron,
            # "tipo": self.tipo.value,
        }
        for k in self.__table__.columns:
            column = k.name
            print(column)
            if column in ["qualificacoes", "recover", "password"]:
                continue
            if column == "tipo":
                print("\nChegamos ao Tipo\n")
                # print(f"{getattr(self, column)=}")
                a = getattr(self, column).value
                print(type(a))
                response[column] = a
                continue

            response[column] = getattr(self, column)
        return response


class Qualificacao(Base):
    __tablename__ = "qualificacoes"

    id: Mapped[int] = mapped_column(primary_key=True)
    nome: Mapped[str] = mapped_column(String(100), nullable=False)
    grupo: Mapped[GrupoQualificações] = mapped_column(
        SQLEnum(GrupoQualificações), nullable=False
    )
    validade: Mapped[int] = mapped_column(Integer, nullable=False)

    tipos_permitidos: Mapped[list["QualificacaoTipoPermitido"]] = relationship(
        back_populates="qualificacao", cascade="all, delete-orphan"
    )
    atribuicoes: Mapped[list["TripulanteQualificacao"]] = relationship(
        back_populates="qualificacao", cascade="all, delete-orphan"
    )


class QualificacaoTipoPermitido(Base):
    __tablename__ = "qualificacao_tipos_permitidos"

    id: Mapped[int] = mapped_column(primary_key=True)
    qualificacao_id: Mapped[int] = mapped_column(
        ForeignKey("qualificacoes.id"), nullable=False
    )
    tipo: Mapped[TipoTripulante] = mapped_column(
        SQLEnum(TipoTripulante), nullable=False
    )

    qualificacao: Mapped["Qualificacao"] = relationship(
        back_populates="tipos_permitidos"
    )


class TripulanteQualificacao(Base):
    __tablename__ = "tripulante_qualificacoes"

    id: Mapped[int] = mapped_column(primary_key=True)
    tripulante_id: Mapped[int] = mapped_column(
        ForeignKey("tripulantes.nip"), nullable=False
    )
    qualificacao_id: Mapped[int] = mapped_column(
        ForeignKey("qualificacoes.id"), nullable=False
    )
    data_ultima_validacao: Mapped[date] = mapped_column(Date, nullable=False)

    tripulante: Mapped["Tripulante"] = relationship(back_populates="qualificacoes")
    qualificacao: Mapped["Qualificacao"] = relationship(back_populates="atribuicoes")

    # def data_expiracao(self):
    #     """Calcula a data de expiração com base na validade da qualificação."""
    #     from dateutil.relativedelta import relativedelta

    #     return self.data_ultima_validacao + relativedelta(
    #         months=self.qualificacao.validade_meses
    #     )
